<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Volume File Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; }
        .upload-area:hover { border-color: #2196F3; background: #f9f9f9; }
        .upload-area.disabled { opacity: 0.5; pointer-events: none; }
        .auth-section { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .auth-section.authenticated { background: #e8f5e8; border-left: 4px solid #4caf50; }
        input[type="password"], input[type="text"] { width: 200px; padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .file-list { margin-top: 20px; }
        .file-item { padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>üöÇ Railway Volume File Upload</h1>
    <p>Upload files directly to your Railway volume at <code>/app/storage/photos/</code></p>
    
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <h3>üîê Authentication Required</h3>
        <div id="loginForm">
            <input type="password" id="passwordInput" placeholder="Admin password" onkeypress="handlePasswordKeypress(event)">
            <button onclick="login()">Login</button>
        </div>
        <div id="authStatus" class="status"></div>
    </div>
    
    <!-- Upload Section (disabled until authenticated) -->
    <div class="upload-area disabled" id="uploadArea" onclick="handleUploadClick()">
        <p>üìÅ Click here or drag files to upload</p>
        <p><small>Authentication required first</small></p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    </div>
    
    <button id="uploadButton" onclick="uploadFiles()" disabled>Upload Selected Files</button>
    
    <div id="results" class="file-list"></div>
    
    <h3>Volume File Management</h3>
    <button id="listButton" onclick="listVolumeFiles()" disabled>üìã List Files in Volume</button>
    <button id="testButton" onclick="testVolumeAccess()" disabled>üîß Test Volume Access</button>
    
    <div id="fileList" class="file-list"></div>

    <script>
        let selectedFiles = [];
        let isAuthenticated = false;

        // Check authentication status on page load
        window.addEventListener('load', checkAuthStatus);

        function handlePasswordKeypress(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/check');
                const result = await response.json();
                
                if (result.authenticated) {
                    setAuthenticatedState(true);
                    document.getElementById('authStatus').innerHTML = 
                        `<span class="success">‚úÖ Authenticated (${Math.floor(result.session_remaining / 60)} minutes remaining)</span>`;
                } else {
                    setAuthenticatedState(false);
                    document.getElementById('authStatus').innerHTML = 
                        '<span class="error">‚ùå Not authenticated</span>';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                setAuthenticatedState(false);
            }
        }

        async function login() {
            const password = document.getElementById('passwordInput').value;
            if (!password) {
                alert('Please enter password');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });

                const result = await response.json();
                
                if (result.success) {
                    setAuthenticatedState(true);
                    document.getElementById('authStatus').innerHTML = 
                        '<span class="success">‚úÖ Login successful!</span>';
                    document.getElementById('passwordInput').value = '';
                } else {
                    document.getElementById('authStatus').innerHTML = 
                        '<span class="error">‚ùå Invalid password</span>';
                }
            } catch (error) {
                document.getElementById('authStatus').innerHTML = 
                    '<span class="error">‚ùå Login failed: ' + error.message + '</span>';
            }
        }

        function setAuthenticatedState(authenticated) {
            isAuthenticated = authenticated;
            const uploadArea = document.getElementById('uploadArea');
            const authSection = document.getElementById('authSection');
            const buttons = ['uploadButton', 'listButton', 'testButton'];
            
            if (authenticated) {
                uploadArea.classList.remove('disabled');
                uploadArea.innerHTML = '<p>üìÅ Click here or drag files to upload</p>';
                authSection.classList.add('authenticated');
                document.getElementById('loginForm').style.display = 'none';
                
                buttons.forEach(id => {
                    document.getElementById(id).disabled = false;
                });
            } else {
                uploadArea.classList.add('disabled');
                uploadArea.innerHTML = '<p>üìÅ Click here or drag files to upload</p><p><small>Authentication required first</small></p>';
                authSection.classList.remove('authenticated');
                document.getElementById('loginForm').style.display = 'block';
                
                buttons.forEach(id => {
                    document.getElementById(id).disabled = true;
                });
            }
        }

        function handleUploadClick() {
            if (isAuthenticated) {
                document.getElementById('fileInput').click();
            } else {
                alert('Please login first');
            }
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            updateFileDisplay();
        });

        function updateFileDisplay() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>Selected Files:</h3>' + 
                selectedFiles.map(file => `
                    <div class="file-item">
                        üìÑ ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)
                    </div>
                `).join('');
        }

        async function uploadFiles() {
            if (!isAuthenticated) {
                alert('Please login first');
                return;
            }

            if (selectedFiles.length === 0) {
                alert('Please select files first');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = '<p>Uploading files...</p>';

            for (const file of selectedFiles) {
                try {
                    // Create a fake member ID for testing (you can change this)
                    const testMemberId = 'volume_test_' + Date.now();
                    
                    const formData = new FormData();
                    formData.append('photo', file);
                    formData.append('member_id', testMemberId);

                    const response = await fetch('/api/photos', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        results.innerHTML += `<div class="file-item success">‚úÖ ${file.name} ‚Üí ${result.filename}</div>`;
                    } else {
                        results.innerHTML += `<div class="file-item error">‚ùå ${file.name}: ${result.error || 'Upload failed'}</div>`;
                    }
                } catch (error) {
                    results.innerHTML += `<div class="file-item error">‚ùå ${file.name}: ${error.message}</div>`;
                }
            }
        }

        async function listVolumeFiles() {
            if (!isAuthenticated) {
                alert('Please login first');
                return;
            }

            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<p>üìã Listing volume files...</p>';
            
            try {
                const response = await fetch('/api/volume-files');
                const result = await response.json();
                
                if (result.success) {
                    fileList.innerHTML = '<h3>üìÅ Files in Volume:</h3>' +
                        `<p><strong>${result.count}</strong> files in <code>${result.volume_path}</code></p>` +
                        result.files.map(file => `
                            <div class="file-item">
                                üìÑ ${file.name} (${(file.size/1024).toFixed(1)} KB) - ${file.modified}
                            </div>
                        `).join('');
                } else {
                    fileList.innerHTML = `<div class="error">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                fileList.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testVolumeAccess() {
            if (!isAuthenticated) {
                alert('Please login first');
                return;
            }

            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<p>üîß Testing volume access...</p>';
            
            try {
                const response = await fetch('/api/volume-test');
                const result = await response.json();
                
                const detailsHtml = result.details ? Object.entries(result.details).map(([key, value]) => {
                    const icon = value === true ? '‚úÖ' : value === false ? '‚ùå' : 'üìä';
                    let displayValue = value;
                    if (key.includes('disk_') && typeof value === 'number') {
                        displayValue = (value / 1024 / 1024 / 1024).toFixed(2) + ' GB';
                    }
                    return `<div>${icon} ${key.replace(/_/g, ' ')}: ${displayValue}</div>`;
                }).join('') : '';
                
                fileList.innerHTML = `
                    <div class="${result.success ? 'success' : 'error'}">
                        ${result.success ? '‚úÖ' : '‚ùå'} ${result.message}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Volume Path:</strong> <code>${result.volume_path}</code>
                    </div>
                    ${detailsHtml ? '<div style="margin-top: 10px; font-size: 0.9em;"><strong>Test Details:</strong><br>' + detailsHtml + '</div>' : ''}
                `;
            } catch (error) {
                fileList.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Drag and drop support
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (isAuthenticated) {
                uploadArea.style.borderColor = '#2196F3';
                uploadArea.style.background = '#f9f9f9';
            }
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            uploadArea.style.borderColor = '#ccc';
            uploadArea.style.background = '';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            uploadArea.style.background = '';
            
            if (isAuthenticated) {
                selectedFiles = Array.from(e.dataTransfer.files);
                updateFileDisplay();
            } else {
                alert('Please login first');
            }
        });
    </script>
</body>
</html>